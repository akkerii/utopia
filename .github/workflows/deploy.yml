name: Deploy to EC2 with Docker

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Test Docker builds locally
        run: |
          echo "Testing backend build..."
          cd utopia-backend
          docker build -t utopia-backend:test . --no-cache
          cd ..

          echo "Testing frontend build..."
          cd utopia-frontend
          docker build -t utopia-frontend:test . --no-cache
          cd ..

          echo "✅ Docker builds successful"

      - name: Prepare deployment files
        run: |
          echo "Creating deployment package..."
          tar -czf deployment.tar.gz \
            --exclude='node_modules' \
            --exclude='.git' \
            --exclude='dist' \
            --exclude='.next' \
            --exclude='coverage' \
            --exclude='*.log' \
            .
          echo "✅ Deployment package created"

      - name: Copy deployment package to EC2
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          source: "deployment.tar.gz"
          target: "/tmp/"
          timeout: 300s

      - name: Deploy with Docker on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 600s
          script: |
            echo "Starting deployment..."

            # Extract deployment package
            cd /tmp
            tar -xzf deployment.tar.gz

            # Make deployment script executable
            chmod +x deploy-docker.sh

            # Run Docker deployment
            export OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
            sudo -E bash deploy-docker.sh

            # Cleanup
            rm -f deployment.tar.gz

            echo "✅ Deployment completed" 

      - name: Health check and verification
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          timeout: 300s
          script: |
            echo "Waiting for services to stabilize..."
            sleep 30

            # Check container status
            cd /var/www/utopia-ai

            echo "=== Container Status ==="
            docker-compose ps

            # Check if containers are running
            if docker-compose ps | grep -E "(Up|running)"; then
              echo "✅ Containers are running"
            else
              echo "❌ Container status check failed"
              echo "=== Container Logs ==="
              docker-compose logs --tail=50
              exit 1
            fi

            # Test endpoints with retries
            echo "Testing endpoints..."

            # Test nginx health
            for i in {1..5}; do
              if curl -f http://localhost/health > /dev/null 2>&1; then
                echo "✅ Nginx health check passed"
                break
              else
                echo "Attempt $i: Nginx health check failed, retrying..."
                sleep 10
              fi
            done

            # Test backend API
            for i in {1..5}; do
              if curl -f http://localhost/api/health > /dev/null 2>&1; then
                echo "✅ Backend API health check passed"
                break
              else
                echo "Attempt $i: Backend API health check failed, retrying..."
                sleep 10
              fi
            done

            echo "🎉 Deployment verification completed!"
            echo "Frontend: http://${{ secrets.EC2_HOST }}"
            echo "API: http://${{ secrets.EC2_HOST }}/api"

      - name: Deployment Summary
        if: always()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          script: |
            echo "=== Final Deployment Summary ==="
            echo "Timestamp: $(date)"
            echo "Commit: ${{ github.sha }}"
            echo "Branch: ${{ github.ref_name }}"
            echo ""
            echo "=== Container Status ==="
            cd /var/www/utopia-ai 2>/dev/null || echo "App directory not found"
            docker-compose ps 2>/dev/null || echo "Docker compose not available"
